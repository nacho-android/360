<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pig Anaesthetic Drug Calculator</title>
<style>
  /* Theme */
  :root{
    --bg:#fafafa;
    --panel:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#e0f2fe;  /* estimated weight highlight */
    --actual:#f0fdf4;  /* actual weight column */
    --chip:#eef2ff;
  }

  html, body{ height:100%; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: var(--bg);
    color: var(--ink);
    margin: 0;
    line-height: 1.35;
  }

  /* Header */
  header{
    position: static;
    background: linear-gradient(#ffffff, #fafafa);
    border-bottom: 1px solid var(--line);
  }
  .wrap{ max-width: 1200px; margin: 0 auto; padding: 10px 12px 18px; }
  h1{ margin: 8px 0 4px; font-size: 1.55rem; }
  .sub{ color: var(--muted); font-size: .95rem; }

  /* Controls panel */
  .controls{
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    padding: 10px;
    margin: 10px 0 8px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
  }

  /* Each control: [label | control] */
  .control{
    display: grid;
    grid-template-columns: max-content 1fr;
    align-items: center;
    column-gap: 10px;
    row-gap: 6px;
  }
  .control > label{
    grid-column: 1;
    font-weight: 600;
    white-space: nowrap;
    margin: 0;
  }
  .control > .row,
  .control > select,
  .control > input{
    grid-column: 2;
    justify-self: start;
  }
  .control > .foot{
    grid-column: 1 / -1;
    color: var(--muted);
    font-size: .85rem;
  }

  /* Row groups (e.g., Actual input + Update button) */
  .row{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    width: max-content;
  }

  /* Inputs / selects */
  .control input,
  .control select{
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 10px;
    font-size: 1rem;
  }
  #estWeightSelect{ width: auto; min-width: 8ch; }
  #actWeight{
    width: 8ch;
    text-align: center;
    line-height: 1.2;
  }
  #applyActual{ white-space: nowrap; }

  /* Buttons */
  .btn{
    appearance: none;
    border: 1px solid var(--line);
    background: #f8fafc;
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 700;
    cursor: pointer;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{ background:#eef2ff; }

  /* Collapsible sections */
  details{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
    margin: 12px 0;
    overflow: hidden;
  }
  summary{
    cursor: pointer;
    list-style: none;
    padding: 12px 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  summary::-webkit-details-marker{ display:none; }
  summary .meta{ font-weight: 500; color: var(--muted); font-size: .95rem; }

  /* Tables */
  .table-wrap{
    padding: 0 0 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
  }
  table.sop{
    border-collapse: collapse;
    table-layout: fixed;
    width: max-content;
    min-width: 100%;
  }
  table.sop th,
  table.sop td{
    border: 1px solid var(--line);
    padding: 7px 7px;
    vertical-align: middle;
  }
  table.sop th{
    background: #f5f7fa;
    text-align: center;
    font-weight: 700;
    position: sticky;
    top: 0;
    z-index: 1;
    white-space: nowrap;
  }
  table.sop td{
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }
  table.sop td:not(:first-child){ text-align: center; }
  table.sop th:first-child{ text-align: left; }
  table.sop td:first-child,
  table.sop th:first-child{
    position: sticky;
    left: 0;
    background: #f9fafb;
    text-align: left;
    z-index: 2;
    width: 150px;
    min-width: 150px;
    white-space: normal;
  }
  .drug-note{
    display: block;
    color: var(--muted);
    font-size: .86rem;
    font-weight: 500;
  }

  /* Column highlights */
  .col-highlight{ background: var(--accent); }
  .actual-col{ background: var(--actual); }

  .note{ color: var(--muted); font-size: .9rem; padding: 6px 2px 0; }

  /* Custom editor styling (Custom table) */
  .custom-cell{ position: relative; }
  .custom-editor{
    display: grid;
    grid-template-columns: 1fr max-content;
    grid-template-rows: auto auto;
    gap: 6px 10px;
    align-items: center;
  }
  .custom-editor .name{
    grid-column: 1 / 2; grid-row: 1;
    width: 18ch;
  }
  .custom-editor .field{
    grid-column: 2 / 3;
    display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }
  .custom-editor .field input{
    width: 9ch;
    text-align: right;
  }
  .custom-editor .below{
    grid-column: 2 / 3; grid-row: 2;
  }
  .custom-editor input{
    padding: 8px 10px;
    border: 1px solid var(--line);
    border-radius: 8px;
    font-size: .95rem;
  }
  .custom-editor label{
    color: var(--muted);
    font-size: .9rem;
    font-weight: 600;
  }

  /* Delete button (lower-left of first column) */
  .custom-del{
    position: absolute;
    left: 6px; bottom: 6px;
    width: 22px; height: 22px;
    line-height: 20px;
    text-align: center;
    border-radius: 6px;
    border: 1px solid var(--line);
    background: #fff;
    cursor: pointer;
    font-weight: 700;
    color: #6b7280;
    padding: 0;
  }
  .custom-del:active{ transform: translateY(1px); }

  /* Responsive tweaks */
  @media (max-width: 640px){
    .wrap{ padding: 8px 8px; }
    h1{ font-size: 1.3rem; }
    .controls{ gap: 8px; padding: 8px; border-radius: 10px; }
    details{ margin: 10px 0; border-radius: 10px; }
    table.sop th, table.sop td{ padding: 2px 2px; font-size: .95rem; }
    table.sop td:first-child, table.sop th:first-child{ width: 150px; min-width: 150px; }
    .custom-editor .name{ width: 14ch; }
  }
</style>

</head>
<body>
<header>
  <div class="wrap">
    <h1>Pig Anaesthetic Drug Calculator</h1>
    <div class="controls">
      <div class="control">
        <label for="estWeightSelect">Estimated pig weight</label>
        <select id="estWeightSelect" aria-label="Estimated weight"></select>
        <div class="foot"></div>
      </div>

      <div class="control">
        <label for="actWeight">Actual pig weight</label>
        <div class="row">
          <input id="actWeight" type="text" inputmode="decimal"
                 pattern="[0-9]*[.,]?[0-9]*" value="30.0" placeholder="e.g. 27.4" />
          <button id="applyActual" class="btn primary">Update</button>
        </div>
        <div class="foot"></div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" id="app"></main>

<script>
(function(){
  /******************** Data & storage ********************/
  const weights = Array.from({length: ((100-20)/5)+1}, (_,i)=>20 + i*5);

  // Safe storage wrapper (localStorage)
  const storage = {
    get(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } },
    set(k,v){ try{ localStorage.setItem(k,v); }catch(e){} },
    remove(k){ try{ localStorage.removeItem(k); }catch(e){} }
  };

  /******************** Helpers ********************/
  const mgkg = (mgPerKg, mgPerMl) => ({ amt: mgPerKg, unit: 'mg_per_kg', conc: mgPerMl, concUnit: 'mg_per_ml' });
  const ugkg = (ugPerKg, ugPerMl) => ({ amt: ugPerKg, unit: 'ug_per_kg', conc: ugPerMl, concUnit: 'ug_per_ml' });
  const mgkgPerHour = (mgPerKgPerH, mgPerMl) => ({ amt: mgPerKgPerH, unit: 'mg_per_kg_per_h', conc: mgPerMl, concUnit: 'mg_per_ml' });
  const ugkgPerHour = (ugPerKgPerH, ugPerMl) => ({ amt: ugPerKgPerH, unit: 'ug_per_kg_per_h', conc: ugPerMl, concUnit: 'ug_per_ml' });
  const mlkg = (mlPerKg) => ({ amt: mlPerKg, unit: 'ml_per_kg' });

  // Decimal places per drug (overrides)
  const DRUG_DP = { propofol:0, ketamine:1, midazolam:1, fentanyl:1, buprenorphine:2, saline:0 };
  function dpFor(drugLabel, override){
    if(override !== undefined && override !== null && override !== '') return Number(override);
    const lbl = String(drugLabel||'').toLowerCase();
    for(const key in DRUG_DP){ if(lbl.includes(key)) return DRUG_DP[key]; }
    return 2;
  }
  function fmtByDrug(drugLabel, n, override){
    const dp = dpFor(drugLabel, override);
    return isFinite(n) ? n.toFixed(dp) : '—';
  }

  function volFor(weightKg, rule){
    const {amt, unit, conc, concUnit} = rule;
    if(unit === 'ml_per_kg'){ return amt * weightKg; }
    let dosePerKg_mg = 0;
    if(unit === 'mg_per_kg' || unit === 'mg_per_kg_per_h') dosePerKg_mg = amt;
    if(unit === 'ug_per_kg' || unit === 'ug_per_kg_per_h') dosePerKg_mg = amt/1000;
    const dose_mg = dosePerKg_mg * weightKg;
    const conc_mg_per_ml = (concUnit === 'mg_per_ml') ? conc : (conc/1000);
    return dose_mg / conc_mg_per_ml;
  }

  function ruleFromRow(tr){
    const amt = parseFloat(tr.dataset.amt);
    const unit = tr.dataset.unit;
    const conc = (tr.dataset.conc !== undefined) ? parseFloat(tr.dataset.conc) : undefined;
    const concUnit = tr.dataset.concu;
    return { amt, unit, conc, concUnit };
  }

  /******************** Data sets ********************/
  const imSedationMinor = [
    { drug: 'Midazolam', spec: '0.4 mg/kg (5 mg/mL)', kind: 'bolus', rule: mgkg(0.4, 5) },
    { drug: 'Butorphanol', spec: '0.1 mg/kg (10 mg/mL)', kind: 'bolus', rule: mgkg(0.1, 10) },
    { drug: 'Medetomidine', spec: '0.02 mg/kg (1 mg/mL)', kind: 'bolus', rule: mgkg(0.02, 1) },
  ];
  const imReversal = [
    { drug: 'Atipamezole [2×]', spec: '0.04 mg/kg (5 mg/mL)', kind: 'bolus', rule: mgkg(0.04, 5) },
    { drug: 'Atipamezole [3×]', spec: '0.06 mg/kg (5 mg/mL)', kind: 'bolus', rule: mgkg(0.06, 5) },
    { drug: 'Atipamezole [4×]', spec: '0.08 mg/kg (5 mg/mL)', kind: 'bolus', rule: mgkg(0.08, 5) },
  ];
  const imPremedLonger = [
    { drug: 'Midazolam', spec: '0.4 mg/kg (5 mg/mL)', kind: 'bolus', rule: mgkg(0.4, 5) },
    { drug: 'Ketamine', spec: '8 mg/kg (100 mg/mL)', kind: 'bolus', rule: mgkg(8, 100) },
    { drug: 'Medetomidine', spec: '0.01 mg/kg (1 mg/mL)', kind: 'bolus', rule: mgkg(0.01, 1) },
  ];
  const ivBoluses = [
    { drug: 'Methadone', spec: '0.3 mg/kg (10 mg/mL)', kind: 'bolus', rule: mgkg(0.3, 10) },
    { drug: 'Fentanyl', spec: '5 µg/kg (50 µg/mL)', kind: 'bolus', rule: ugkg(5, 50) },
    { drug: 'Propofol', spec: '1 mg/kg (10 mg/mL)', kind: 'bolus', rule: mgkg(1, 10) },
  ];
  const tivaPropofol = [2,4,6,8,10,12].map(r => ({ drug: `${r} mg/kg/h`, spec: '', kind: 'infusion', rule: mgkgPerHour(r, 10), dp: 0 }));
  const tivaMidazolam = [0.1,0.2,0.3,0.4].map(r => ({ drug: `${r} mg/kg/h`, spec: '', kind: 'infusion', rule: mgkgPerHour(r, 1), dp: 1 }));
  const tivaFentanyl  = [1,2,5,10,15].map(r => ({ drug: `${r} µg/kg/h`, spec: '', kind: 'infusion', rule: ugkgPerHour(r, 50), dp: 1 }));
  const other = [
    { drug: 'Buprenorphine', spec: '0.02 mg/kg<br>(0.3 mg/mL)', kind: 'bolus', rule: mgkg(0.02, 0.3), dp: 2 },
    { drug: 'Saline', spec: '4 mL/kg/h', kind: 'bolus', rule: mlkg(4), dp: 0 },
    { drug: 'Saline', spec: '5 mL/kg/h', kind: 'bolus', rule: mlkg(5), dp: 0 },
    { drug: 'Saline', spec: '6 mL/kg/h', kind: 'bolus', rule: mlkg(6), dp: 0 },
  ];
  const misc = [
    { drug: 'Heparin', initial: '5,000 IU bolus', maint: 'Repeat 2,000 IU after 1 h, then 1,000 IU hourly (Target ACT 250–300 s)' },
    { drug: 'Metaraminol<br>(0.5 mg/mL)', initial: '0.5–1 mL bolus', maint: 'Repeat as required; wait 1–2 min between boluses' },
    { drug: 'Adrenaline<br>(1:20,000)', initial: '1–2 mL bolus', maint: 'As required' },
    { drug: 'Atropine', initial: '600 µg bolus', maint: 'As required' },
    { drug: 'Amiodarone<br>(3 mg/mL in 5% glucose)', initial: '150 mg (or 5 mg/kg) over 30 min', maint: 'As required' },
    { drug: 'Lignocaine', initial: '100 mg (or 3 mg/kg) slowly', maint: '30–60 mg/h (or 1–2 mg/kg/h)' },
    { drug: 'Metoprolol', initial: '1 mg slowly', maint: 'As required' },
  ];

  /******************** Build table utilities ********************/
  function buildDoseTable(sectionId, title, note, rows){
    const tblId = `tbl-${sectionId}`;
    const details = document.createElement('details');
    details.open = (storage.get('open:'+sectionId) ?? '1') === '1';
    details.id = sectionId;
    details.addEventListener('toggle', ()=> storage.set('open:'+sectionId, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>${title}</span><span class="meta">Units: mL${title.includes('TIVA') ? '/h' : ''}</span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrap sync-scroll';

    const table = document.createElement('table');
    table.className = 'sop';
    table.id = tblId;

    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    const thDrug = document.createElement('th'); thDrug.textContent = 'Drug'; htr.appendChild(thDrug);
    weights.forEach(w=>{
      const th = document.createElement('th');
      th.textContent = `${w} kg`;
      th.dataset.w = String(w);
      htr.appendChild(th);
    });
    thead.appendChild(htr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.dataset.amt = String(r.rule.amt);
      tr.dataset.unit = r.rule.unit;
      if(r.rule.conc !== undefined){ tr.dataset.conc = String(r.rule.conc); }
      if(r.rule.concUnit){ tr.dataset.concu = r.rule.concUnit; }
      tr.dataset.drugLabel = r.drug;
      tr.dataset.dp = r.dp !== undefined ? String(r.dp) : '';

      const tdName = document.createElement('td');
      tdName.style.textAlign = 'left';
      tdName.innerHTML = `<div><strong>${r.drug}</strong><span class="drug-note">${r.spec}</span></div>`;
      tr.appendChild(tdName);

      weights.forEach(w=>{
        const td = document.createElement('td');
        const mL = volFor(w, ruleFromRow(tr));
        const dpOverride = tr.dataset.dp === '' ? undefined : Number(tr.dataset.dp);
        td.textContent = fmtByDrug(tr.dataset.drugLabel, mL, dpOverride);
        td.dataset.w = String(w);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    wrap.appendChild(table);

    if(note){
      const foot = document.createElement('div');
      foot.className = 'note';
      foot.innerHTML = note;
      wrap.appendChild(foot);
    }

    details.appendChild(wrap);
    app.appendChild(details);
    return table;
  }

  function buildMiscTable(){
    const details = document.createElement('details');
    details.id = 'p11-misc';
    details.open = (storage.get('open:'+details.id) ?? '1') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>Miscellaneous Intravenous Drug Doses</span><span class="meta"></span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrap sync-scroll';

    const table = document.createElement('table'); table.className = 'sop'; table.id = 'tbl-misc';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['Drug', 'Initial / Loading Dose', 'Maintenance'].forEach((txt)=>{
      const th = document.createElement('th'); th.textContent = txt; trh.appendChild(th);
    });
    thead.appendChild(trh); table.appendChild(thead);

    const tbody = document.createElement('tbody');
    misc.forEach(row=>{
      const tr = document.createElement('tr');
      const drug = document.createElement('td'); drug.style.textAlign='left'; drug.innerHTML = `<strong>${row.drug}</strong>`; tr.appendChild(drug);
      const init = document.createElement('td'); init.textContent = row.initial; tr.appendChild(init);
      const maint = document.createElement('td'); maint.textContent = row.maint; tr.appendChild(maint);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrap.appendChild(table);
    const foot = document.createElement('div'); foot.className='note'; foot.textContent = ''; wrap.appendChild(foot);

    details.appendChild(wrap);
    app.appendChild(details);
    return table;
  }

  /******************** Custom table (persist + delete) ********************/
  const CUSTOM_KEY = 'customRowsV1';
  function loadCustomRows(){
    try{
      const raw = storage.get(CUSTOM_KEY);
      const rows = raw ? JSON.parse(raw) : [];
      return Array.isArray(rows) ? rows : [];
    }catch(e){ return []; }
  }
  function saveCustomRows(rows){ storage.set(CUSTOM_KEY, JSON.stringify(rows)); }
  function genId(){ return 'r' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

  let customRows = [];   // in-memory mirror
  let tablesReady = false; // <— prevents early recalcs before setup finishes

  function buildCustomTable(){
    const sectionId = 'p12-custom';
    const details = document.createElement('details');
    details.id = sectionId;
    details.open = (storage.get('open:'+details.id) ?? '1') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>Custom</span><span class="meta">Units: mL</span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrap sync-scroll';

    const table = document.createElement('table');
    table.className = 'sop';
    table.id = 'tbl-custom';

    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    const thDrug = document.createElement('th'); thDrug.textContent = 'Drug'; htr.appendChild(thDrug);
    weights.forEach(w=>{
      const th = document.createElement('th');
      th.textContent = `${w} kg`;
      th.dataset.w = String(w);
      htr.appendChild(th);
    });
    thead.appendChild(htr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    table.appendChild(tbody);

    wrap.appendChild(table);

    const foot = document.createElement('div');
    foot.className = 'note';
    const addBtn = document.createElement('button');
    addBtn.className = 'btn';
    addBtn.textContent = 'Add row';
    addBtn.addEventListener('click', ()=>{
      const rowObj = { id: genId(), name: '', mgkg: '', mgml: '' };
      customRows.push(rowObj);
      saveCustomRows(customRows);
      addCustomRow(tbody, rowObj);
      if(tablesReady){
        updateHighlights(currentEstimated());
        repositionActualAcrossTables(currentActual());
      }
    });
    foot.appendChild(addBtn);
    wrap.appendChild(foot);

    details.appendChild(wrap);
    app.appendChild(details);

    // Populate from storage (or one blank row)
    const stored = loadCustomRows();
    if(stored.length === 0){
      const rowObj = { id: genId(), name: '', mgkg: '', mgml: '' };
      customRows = [rowObj];
      saveCustomRows(customRows);
      addCustomRow(tbody, rowObj);
    }else{
      customRows = stored;
      customRows.forEach(r => addCustomRow(tbody, r));
    }

  const initW = Number(storage.get('estWeight'));
  const initA = Number(storage.get('actWeight'));
  requestAnimationFrame(() => {
    updateHighlights(Number.isFinite(initW) && initW > 0 ? initW : 20);
    repositionActualAcrossTables(Number.isFinite(initA) && initA > 0 ? initA : 20);
  });

    return table;
  }

  function addCustomRow(tbody, rowObj){
    const tr = document.createElement('tr');
    tr.dataset.id = rowObj.id;
    tr.dataset.unit = 'mg_per_kg';
    tr.dataset.concu = 'mg_per_ml';
    tr.dataset.amt = rowObj.mgkg ?? '';
    tr.dataset.conc = rowObj.mgml ?? '';
    tr.dataset.drugLabel = rowObj.name ?? '';
    tr.dataset.dp = '2'; // force 2 dp (incl. actual column)

    // First cell: editor + delete button
    const tdName = document.createElement('td');
    tdName.className = 'custom-cell';
    tdName.style.textAlign = 'left';

    const editor = document.createElement('div');
    editor.className = 'custom-editor';

    const nameInput = document.createElement('input');
    nameInput.className = 'name';
    nameInput.placeholder = 'Drug name';
    nameInput.setAttribute('aria-label', 'Custom drug name');
    nameInput.value = rowObj.name ?? '';

    const mgkgWrap = document.createElement('div');
    mgkgWrap.className = 'field';
    const mgkgLabel = document.createElement('label'); mgkgLabel.textContent = 'mg/kg';
    const mgkgInput = document.createElement('input');
    mgkgInput.type = 'number'; mgkgInput.step = '0.01'; mgkgInput.min = '0';
    mgkgInput.inputMode = 'decimal'; mgkgInput.placeholder = '0.00';
    mgkgInput.setAttribute('aria-label', 'Dose mg per kg');
    mgkgInput.value = rowObj.mgkg ?? '';

    mgkgWrap.appendChild(mgkgLabel); mgkgWrap.appendChild(mgkgInput);

    const mgmlWrap = document.createElement('div');
    mgmlWrap.className = 'field below';
    const mgmlLabel = document.createElement('label'); mgmlLabel.textContent = 'mg/mL';
    const mgmlInput = document.createElement('input');
    mgmlInput.type = 'number'; mgmlInput.step = '0.01'; mgmlInput.min = '0';
    mgmlInput.inputMode = 'decimal'; mgmlInput.placeholder = '0.00';
    mgmlInput.setAttribute('aria-label', 'Concentration mg per mL');
    mgmlInput.value = rowObj.mgml ?? '';

    mgmlWrap.appendChild(mgmlLabel); mgmlWrap.appendChild(mgmlInput);

    const delBtn = document.createElement('button');
    delBtn.className = 'custom-del'; delBtn.type = 'button';
    delBtn.title = 'Delete row'; delBtn.setAttribute('aria-label','Delete custom row');
    delBtn.textContent = '×';
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this custom row?')){
        tr.remove();
        customRows = customRows.filter(r => r.id !== rowObj.id);
        if(customRows.length === 0){
          const newRow = { id: genId(), name: '', mgkg: '', mgml: '' };
          customRows.push(newRow);
          addCustomRow(tbody, newRow);
        }
        saveCustomRows(customRows);
        if(tablesReady){ repositionActualAcrossTables(currentActual()); }
      }
    });

    editor.appendChild(nameInput);
    editor.appendChild(mgkgWrap);
    editor.appendChild(mgmlWrap);

    tdName.appendChild(editor);
    tdName.appendChild(delBtn);
    tr.appendChild(tdName);

    // Data cells (— initially)
    weights.forEach(w=>{
      const td = document.createElement('td');
      td.dataset.w = String(w);
      td.textContent = '—';
      tr.appendChild(td);
    });

    // Render helper for this row
    function renderRow(){
      tr.dataset.drugLabel = nameInput.value || '';
      tr.dataset.amt = mgkgInput.value || '';
      tr.dataset.conc = mgmlInput.value || '';

      // Update persisted model
      const idx = customRows.findIndex(r => r.id === rowObj.id);
      if(idx !== -1){
        customRows[idx] = {
          id: rowObj.id,
          name: tr.dataset.drugLabel,
          mgkg: tr.dataset.amt,
          mgml: tr.dataset.conc
        };
        saveCustomRows(customRows);
      }

      // Update each weight column
      weights.forEach(w=>{
        const td = tr.querySelector(`td[data-w="${w}"]`);
        const rule = ruleFromRow(tr);
        const mL = volFor(w, rule);
        td.textContent = fmtByDrug(tr.dataset.drugLabel, mL, 2); // force 2 dp
      });

      // Only try to reposition after setup is complete
      if(tablesReady){ repositionActualAcrossTables(currentActual()); }
    }

    nameInput.addEventListener('input', renderRow);
    mgkgInput.addEventListener('input', renderRow);
    mgmlInput.addEventListener('input', renderRow);

    tbody.appendChild(tr);
    renderRow(); // safe: guarded by tablesReady
  }

  /******************** App root ********************/
  const app = document.getElementById('app');

  // Build all sections
  const tbl1  = buildDoseTable('p5-im-minor', 'IM Sedation for Minor Procedures', '', imSedationMinor);
  const tbl1b = buildDoseTable('p5-im-reversal', 'IM Reversal', 'Use 2–4× the medetomidine dose', imReversal);
  const tbl1c = buildDoseTable('p5-im-premed', 'IM Premedication for Longer Procedures', '', imPremedLonger);

  const tbl2  = buildDoseTable('p6-iv-bolus', 'IV Boluses / Induction', '', ivBoluses);

  const tbl3a = buildDoseTable('p8-tiva-prop', 'TIVA — Propofol (10 mg/mL)', '', tivaPropofol);
  const tbl3b = buildDoseTable('p8-tiva-mid', 'TIVA — Midazolam (1 mg/mL)', '', tivaMidazolam);
  const tbl3c = buildDoseTable('p8-tiva-fent', 'TIVA — Fentanyl (50 µg/mL)', '', tivaFentanyl);

  const tblOther = buildDoseTable('p9-other', 'Other', '', [
    ...other
  ]);

  const tbl4  = buildMiscTable();

  const tblCustom = buildCustomTable();

  // Tables used for highlights & actual column placement
  const allTables = [tbl1, tbl1b, tbl1c, tbl2, tbl3a, tbl3b, tbl3c, tblOther, tblCustom];

  /******************** Estimated & actual controls ********************/
  const estSelect = document.getElementById('estWeightSelect');
  const actInput = document.getElementById('actWeight');
  const applyBtn = document.getElementById('applyActual');

  let estVal = 20; // default

  // Populate options 20..100 step 5
  weights.forEach(w => {
    const opt = document.createElement('option');
    opt.value = String(w);
    opt.textContent = `${w} kg`;
    estSelect.appendChild(opt);
  });
  estSelect.value = String(estVal);

  estSelect.addEventListener('change', (e) => setEstimated(Number(e.target.value)));
  estSelect.addEventListener('input',  (e) => setEstimated(Number(e.target.value)));

  function clampToStep(num, min, max, step){
    const n = Math.round((Number(num)-min)/step)*step + min; return Math.max(min, Math.min(max, n));
  }
  function currentActual(){
    const el = document.getElementById('actWeight');
    return Number((el && el.value) ? el.value : 0);
  }
  function currentEstimated(){ return estVal; }

  function setEstimated(v){
    estVal = clampToStep(v, 20, 100, 5);
    if(estSelect && estSelect.value !== String(estVal)) estSelect.value = String(estVal);
    updateHighlights(estVal);
    repositionActualAcrossTables(currentActual());
    storage.set('estWeight', String(estVal));
  }

  // Select-all behaviour
  actInput.addEventListener('focus', () => {requestAnimationFrame(() => actInput.select());});
  actInput.addEventListener('mouseup', (e) => e.preventDefault());
  actInput.addEventListener('pointerup', (e) => e.preventDefault());

  function syncActual(val){
    const v = Math.max(1, Math.min(300, Number(val)));
    actInput.value = String(v.toFixed(1));
    repositionActualAcrossTables(v);
    storage.set('actWeight', String(v.toFixed(1)));
  }

  applyBtn.addEventListener('click', ()=> syncActual(Number(actInput.value)) );
  actInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); syncActual(Number(actInput.value)); }});

  /******************** Column highlights & actual column ********************/
  function updateHighlights(w){
    document.querySelectorAll('table.sop').forEach(tbl=>{
      tbl.querySelectorAll('th,td').forEach(cell=>cell.classList.remove('col-highlight'));
      const th = tbl.querySelector(`thead th[data-w="${w}"]`);
      if(th) th.classList.add('col-highlight');
      tbl.querySelectorAll(`tbody td[data-w="${w}"]`).forEach(td=>td.classList.add('col-highlight'));
    });
  }

  function insertionIndexForWeight(tbl, weight){
    let countLE = 0;
    for(const w of weights){ if(weight >= w) countLE++; }
    return 1 + countLE;
  }

  function repositionActualAcrossTables(weight){
    allTables.forEach(tbl=> repositionActualForTable(tbl, weight));
  }

  function repositionActualForTable(tbl, weight){
    const theadRow = tbl.tHead.rows[0];
    const tbody = tbl.tBodies[0];

    // Remove any existing actual column
    theadRow.querySelectorAll('th.actual-col').forEach(el=>el.remove());
    tbody.querySelectorAll('td.actual-col').forEach(el=>el.remove());

    // Compute insertion index
    const insertIdx = insertionIndexForWeight(tbl, weight);

    // Header cell
    const thAct = document.createElement('th');
    thAct.className = 'actual-col';
    thAct.textContent = `[${weight.toFixed(1)} kg]`;
    theadRow.insertBefore(thAct, theadRow.children[insertIdx] || null);

    // Body cells
    Array.from(tbody.rows).forEach(tr=>{
      const td = document.createElement('td');
      td.className = 'actual-col';
      const rule = ruleFromRow(tr);
      const drugLabel = tr.dataset.drugLabel || '';
      const dpOverride = (tbl.id === 'tbl-custom') ? 2 : (tr.dataset.dp === '' ? undefined : Number(tr.dataset.dp));
      td.textContent = fmtByDrug(drugLabel, volFor(weight, rule), dpOverride);
      tr.insertBefore(td, tr.children[insertIdx] || null);
    });
  }

  /******************** Synced horizontal scrolling ********************/
  const scrollers = Array.from(document.querySelectorAll('.sync-scroll'));
  let syncing = false;
  scrollers.forEach(el=>{
    el.addEventListener('scroll', ()=>{
      if(syncing) return; syncing = true;
      const x = el.scrollLeft;
      scrollers.forEach(other=>{ if(other!==el) other.scrollLeft = x; });
      requestAnimationFrame(()=>{ syncing = false; });
    }, {passive:true});
  });

  /******************** Initial render ********************/
  // mark tables as ready BEFORE we do first highlight/reposition so Custom's early renders are safe to trigger later
  tablesReady = true;

  const savedEst = Number(storage.get('estWeight'));
  const savedAct = Number(storage.get('actWeight'));
  setEstimated(isFinite(savedEst) && savedEst > 0 ? savedEst : 20);
  syncActual(isFinite(savedAct) && savedAct > 0 ? savedAct : 20.0);
})();
</script>
</body>
</html>
