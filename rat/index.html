<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rat Dose Calculator</title>
<style>
  /* Theme */
  :root{
    --bg:#fafafa;
    --panel:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --line:#e5e7eb;
    --chip:#eef2ff;
    --good:#10b981;
    --warn:#f59e0b;
    --bad:#ef4444;
  }

  html, body{ height:100%; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: var(--bg);
    color: var(--ink);
    margin: 0;
    line-height: 1.35;
  }

  /* Header */
  header{
    position: static;
    background: linear-gradient(#ffffff, #fafafa);
    border-bottom: 1px solid var(--line);
  }
  .wrap{ max-width: 1200px; margin: 0 auto; padding: 10px 12px 18px; }
  h1{ margin: 8px 0 4px; font-size: 1.55rem; }
  .sub{ color: var(--muted); font-size: .95rem; }

  /* Controls panel */
  .controls{
    display: grid;
    gap: 10px;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    padding: 10px;
    margin: 10px 0 8px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
  }

  /* Each control: [label | control] */
  .control{
    display: grid;
    grid-template-columns: max-content 1fr;
    align-items: center;
    column-gap: 10px;
    row-gap: 6px;
  }
  .control > label{
    grid-column: 1;
    font-weight: 600;
    white-space: nowrap;
    margin: 0;
  }
  .control > .row,
  .control > select,
  .control > input{
    grid-column: 2;
    justify-self: start;
  }
  .control > .foot{
    grid-column: 1 / -1;
    color: var(--muted);
    font-size: .85rem;
  }

  /* Row groups */
  .row{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    width: max-content;
  }

  /* Inputs / selects */
  .control input,
  .control select{
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 10px;
    font-size: 1rem;
  }
  #actWeight{
    width: 10ch;
    text-align: center;
    line-height: 1.2;
  }
  #applyActual{ white-space: nowrap; }

  /* Buttons */
  .btn{
    appearance: none;
    border: 1px solid var(--line);
    background: #f8fafc;
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 700;
    cursor: pointer;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{ background:#eef2ff; }
  .btn.good{ background:#ecfdf5; border-color:#d1fae5; }
  .btn.warn{ background:#fffbeb; border-color:#fef3c7; }
  .btn.bad{ background:#fef2f2; border-color:#fee2e2; }

  /* Collapsible sections */
  details{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
    margin: 12px 0;
    overflow: hidden;
  }
  summary{
    cursor: pointer;
    list-style: none;
    padding: 12px 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  summary::-webkit-details-marker{ display:none; }
  summary .meta{ font-weight: 500; color: var(--muted); font-size: .95rem; }

  /* Tables */
  .table-wrap{
    padding: 0 0 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-beavior-x: contain;
  }
  table.sop{
    border-collapse: collapse;
    table-layout: fixed;
    width: max-content;
    min-width: 100%;
  }
  table.sop th,
  table.sop td{
    border: 1px solid var(--line);
    padding: 7px 7px;
    vertical-align: middle;
  }
  table.sop th{
    background: #f5f7fa;
    text-align: center;
    font-weight: 700;
    position: sticky;
    top: 0;
    z-index: 1;
    white-space: nowrap;
  }
  table.sop td{
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }
  table.sop td:not(:first-child){ text-align: center; }
  table.sop th:first-child{ text-align: left; }
  table.sop td:first-child,
  table.sop th:first-child{
    position: sticky;
    left: 0;
    background: #f9fafb;
    text-align: left;
    z-index: 2;
    width: 240px;
    min-width: 240px;
    white-space: normal;
  }
  .drug-note{ display: block; color: var(--muted); font-size: .86rem; font-weight: 500; }

  .note{ color: var(--muted); font-size: .9rem; padding: 6px 10px 10px; }

  /* Custom editor */
  .custom-cell{ position: relative; }
  .custom-editor{
    display: grid;
    grid-template-columns: 1fr;
    grid-auto-rows: auto;
    gap: 6px;
    align-items: start;
  }
  .custom-editor .name{ grid-column: 1; width: 18ch; }
  .custom-editor .field{ grid-column: 1; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
  .custom-editor .field input{ width: 9ch; text-align: right; }
  .custom-editor input,
  .custom-editor select{
    padding: 8px 10px;
    border: 1px solid var(--line);
    border-radius: 8px;
    font-size: .95rem;
  }
  .custom-editor label{ color: var(--muted); font-size: .9rem; font-weight: 600; }
  .custom-del{
    position: absolute; left: 6px; bottom: 6px; width: 22px; height: 22px; line-height: 20px;
    text-align: center; border-radius: 6px; border: 1px solid var(--line); background: #fff; cursor: pointer; font-weight: 700; color: #6b7280; padding: 0;
  }
  .custom-del:active{ transform: translateY(1px); }

  /* Notes */
  .notes-text{
    width: 100%; min-height: 64px; max-height: 240px; resize: vertical;
    padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; font-size: .95rem; line-height: 1.3;
  }
  .note-row{ position: relative; }
  .note-del{
    position: absolute; left: 6px; bottom: 6px; width: 22px; height: 22px; line-height: 20px;
    text-align: center; border-radius: 6px; border: 1px solid var(--line); background: #fff; cursor: pointer; font-weight: 700; color: #6b7280; padding: 0;
  }
  .note-del:active{ transform: translateY(1px); }

  /* Sync table */
  .sync-field{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .sync-field input[type="text"]{
    padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; font-size: .95rem; min-width: 24ch;
  }
  .status{ font-size: .92rem; padding: 6px 0 0; }
  .status.ok{ color: var(--good); }
  .status.warn{ color: var(--warn); }
  .status.err{ color: var(--bad); }

  /* Responsive tweaks */
  @media (max-width: 640px){
    .wrap{ padding: 8px 8px; }
    h1{ font-size: 1.3rem; }
    .controls{ gap: 8px; padding: 8px; border-radius: 10px; }
    details{ margin: 10px 0; border-radius: 10px; }
    table.sop th, table.sop td{ padding: 2px 2px; font-size: .95rem; }
    table.sop td:first-child, table.sop th:first-child{ width: 220px; min-width: 220px; }
    .custom-editor .name{ width: 14ch; }
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Rat Dose Calculator</h1>
    <div class="controls">
      <div class="control">
        <label for="actWeight">Rat weight (g)</label>
        <div class="row">
          <input id="actWeight" type="text" inputmode="decimal"
                 pattern="[0-9]*[.,]?[0-9]*" value="" placeholder="e.g. 250" />
          <button id="applyActual" class="btn primary">Update</button>
        </div>
        <div class="foot"></div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" id="app"></main>

<!-- Firebase + App logic (module) -->
<script type="module">
  /******************** Firebase (CDN v9+ modular) ********************/
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
  import { getDatabase, ref, get, set, onValue, off } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

  // TODO: Fill with your project config (Project settings → Your apps)
  const firebaseConfig = {
    apiKey: "AIzaSyAI31CvR3dNW_jzl1-A_bOG_ClA8TABdu8",
    authDomain: "drug-calc-dc52c.firebaseapp.com",
    databaseURL: "https://drug-calc-dc52c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "drug-calc-dc52c",
    storageBucket: "drug-calc-dc52c.firebasestorage.app",
    messagingSenderId: "301558271217",
    appId: "1:301558271217:web:ecb1b726c9c9254d13ed50",
    measurementId: "G-KFR5KK1276"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getDatabase(fbApp);
  const pathForId = (id) => `ratcalc/v1/${id}`;

  /******************** Local storage ********************/
  const storage = {
    get(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } },
    set(k,v){ try{ localStorage.setItem(k,v); }catch(e){} },
    remove(k){ try{ localStorage.removeItem(k); }catch(e){} }
  };

  /******************** Helpers ********************/
  const mgkg = (mgPerKg, mgPerMl) => ({ amt: mgPerKg, unit: 'mg_per_kg', conc: mgPerMl, concUnit: 'mg_per_ml' });
  const mlkg = (mlPerKg) => ({ amt: mlPerKg, unit: 'ml_per_kg' });

  function parseWeightG(raw){
    const s = String(raw ?? '').trim();
    if(!s) return null;
    const n = Number(s.replace(',', '.'));
    if(!Number.isFinite(n) || n <= 0) return null;
    return n;
  }

  function volFor(weightG, rule){
    if(weightG === null) return null;
    const weightKg = weightG / 1000;
    if(!Number.isFinite(weightKg) || weightKg <= 0) return null;

    const {amt, unit, conc, concUnit} = rule;
    if(unit === 'ml_per_kg'){
      return amt * weightKg;
    }
    // mg/kg → mg; then mg/mL → mL
    if(unit === 'mg_per_kg'){
      const doseMg = amt * weightKg;
      const concMgPerMl = (concUnit === 'mg_per_ml') ? conc : null;
      if(!Number.isFinite(doseMg) || !Number.isFinite(concMgPerMl) || concMgPerMl <= 0) return null;
      return doseMg / concMgPerMl;
    }
    return null;
  }

  function roundTo2(n, mode){
    if(!Number.isFinite(n)) return null;
    const f = 100;
    if(mode === 'up') return Math.ceil(n * f) / f;
    if(mode === 'down') return Math.floor(n * f) / f;
    return Math.round(n * f) / f; // 'round'
  }

  function fmt2(n){
    return (n === null) ? '--' : n.toFixed(2);
  }

  function ruleFromRow(tr){
    const amt = parseFloat(tr.dataset.amt);
    const unit = tr.dataset.unit;
    const conc = (tr.dataset.conc !== undefined) ? parseFloat(tr.dataset.conc) : undefined;
    const concUnit = tr.dataset.concu;
    if(!Number.isFinite(amt)) return null;
    if(unit === 'ml_per_kg') return { amt, unit };
    if(unit === 'mg_per_kg'){
      if(!Number.isFinite(conc)) return null;
      return { amt, unit, conc, concUnit: concUnit || 'mg_per_ml' };
    }
    return null;
  }

  /******************** Data sets ********************/
  const drugs = [
    { drug: 'Buprenorphine 1:10', spec: 'max 0.05 mg/kg (0.03 mg/ml)', rule: mgkg(0.05, 0.03), round: 'down' },
    { drug: 'Enrofloxacin 1:10', spec: 'min 10 mg/kg (5 mg/ml)',      rule: mgkg(10, 5),       round: 'up'   },
    { drug: 'Meloxicam 1:10',     spec: 'max 2 mg/kg (2 mg/ml)',      rule: mgkg(2, 2),        round: 'down' },
    { drug: 'Bupivacaine 1:10',   spec: 'max 1 mg/kg (0.5 mg/ml)',    rule: mgkg(1, 0.5),      round: 'down' },
    { drug: 'Saline',             spec: 'max 10 ml/kg',               rule: mlkg(10),          round: 'down' }
  ];

  /******************** App root ********************/
  const app = document.getElementById('app');

  /******************** Build table utilities ********************/
  function buildDoseTable(sectionId, title, note, rows){
    const tblId = `tbl-${sectionId}`;
    const details = document.createElement('details');
    details.open = (storage.get('open:'+sectionId) ?? '1') === '1';
    details.id = sectionId;
    details.addEventListener('toggle', ()=> storage.set('open:'+sectionId, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    const titleSpan = document.createElement('span');
    titleSpan.className = 'section-title';
    titleSpan.textContent = title;
    const metaSpan = document.createElement('span');
    metaSpan.className = 'meta';
    summary.appendChild(titleSpan);
    summary.appendChild(metaSpan);
    details.appendChild(summary);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrap';

    const table = document.createElement('table');
    table.className = 'sop';
    table.id = tblId;

    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    const thDrug = document.createElement('th'); thDrug.textContent = 'Drug'; htr.appendChild(thDrug);
    const thMl = document.createElement('th'); thMl.textContent = 'mL'; htr.appendChild(thMl);
    thead.appendChild(htr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.dataset.amt = String(r.rule.amt);
      tr.dataset.unit = r.rule.unit;
      if(r.rule.conc !== undefined){ tr.dataset.conc = String(r.rule.conc); }
      if(r.rule.concUnit){ tr.dataset.concu = r.rule.concUnit; }
      tr.dataset.round = r.round || 'round';

      const tdName = document.createElement('td');
      tdName.style.textAlign = 'left';
      tdName.innerHTML = `<div><strong>${r.drug}</strong><span class="drug-note">${r.spec || ''}</span></div>`;
      tr.appendChild(tdName);

      const td = document.createElement('td');
      td.className = 'dose-cell';
      td.textContent = '--';
      tr.appendChild(td);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);

    if(note){
      const foot = document.createElement('div');
      foot.className = 'note';
      foot.innerHTML = note;
      wrap.appendChild(foot);
    }

    details.appendChild(wrap);
    app.appendChild(details);
    return table;
  }

  /******************** Custom table (persist + delete) ********************/
  const CUSTOM_KEY = 'ratCustomRowsV2';
  function loadCustomRows(){
    try{
      const raw = storage.get(CUSTOM_KEY);
      const rows = raw ? JSON.parse(raw) : [];
      return Array.isArray(rows) ? rows : [];
    }catch(e){
      return [];
    }
  }
  function saveCustomRows(rows){ storage.set(CUSTOM_KEY, JSON.stringify(rows)); }
  function genId(){ return 'r' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

  let customRows = [];
  let notesRows = [];
  let tablesReady = false;

  function buildCustomTable(){
    const sectionId = 'p12-custom';
    const details = document.createElement('details');
    details.id = sectionId;
    details.open = (storage.get('open:'+details.id) ?? '1') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>Custom</span><span class="meta"></span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div');
    wrap.className = 'table-wrap';

    const table = document.createElement('table');
    table.className = 'sop';
    table.id = 'tbl-custom';

    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    const thDrug = document.createElement('th'); thDrug.textContent = 'Drug'; htr.appendChild(thDrug);
    const thMl = document.createElement('th'); thMl.textContent = 'mL'; htr.appendChild(thMl);
    thead.appendChild(htr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    table.appendChild(tbody);

    wrap.appendChild(table);

    const foot = document.createElement('div');
    foot.className = 'note';
    const addBtn = document.createElement('button');
    addBtn.className = 'btn';
    addBtn.textContent = 'Add row';
    addBtn.addEventListener('click', ()=>{
      const rowObj = { id: genId(), name: '', mgkg: '', mgml: '', roundMode: 'round' };
      customRows.push(rowObj);
      saveCustomRows(customRows);
      addCustomRow(tbody, rowObj);
      if(tablesReady){
        updateDoseTables();
        if(!isApplyingRemote) scheduleCloudPush();
      }
    });
    foot.appendChild(addBtn);
    wrap.appendChild(foot);

    details.appendChild(wrap);
    app.appendChild(details);

    const stored = loadCustomRows();
    if(stored.length === 0){
      const rowObj = { id: genId(), name: '', mgkg: '', mgml: '', roundMode: 'round' };
      customRows = [rowObj];
      saveCustomRows(customRows);
      addCustomRow(tbody, rowObj);
    }else{
      customRows = stored.map(r => ({
        id: r.id || genId(),
        name: r.name ?? '',
        mgkg: r.mgkg ?? '',
        mgml: r.mgml ?? '',
        roundMode: (r.roundMode === 'down' || r.roundMode === 'up' || r.roundMode === 'round') ? r.roundMode : 'round'
      }));
      saveCustomRows(customRows);
      customRows.forEach(r => addCustomRow(tbody, r));
    }

    return table;
  }

  function addCustomRow(tbody, rowObj){
    const tr = document.createElement('tr');
    tr.dataset.id = rowObj.id;
    tr.dataset.unit = 'mg_per_kg';
    tr.dataset.concu = 'mg_per_ml';
    tr.dataset.amt = rowObj.mgkg ?? '';
    tr.dataset.conc = rowObj.mgml ?? '';
    tr.dataset.round = rowObj.roundMode ?? 'round';

    const tdName = document.createElement('td');
    tdName.className = 'custom-cell';
    tdName.style.textAlign = 'left';

    const editor = document.createElement('div');
    editor.className = 'custom-editor';

    const nameInput = document.createElement('input');
    nameInput.className = 'name';
    nameInput.placeholder = 'Drug name';
    nameInput.setAttribute('aria-label', 'Custom drug name');
    nameInput.value = rowObj.name ?? '';

    const mgkgWrap = document.createElement('div');
    mgkgWrap.className = 'field';
    const mgkgLabel = document.createElement('label'); mgkgLabel.textContent = 'mg/kg';
    const mgkgInput = document.createElement('input');
    mgkgInput.type = 'number'; mgkgInput.step = '0.01'; mgkgInput.min = '0';
    mgkgInput.inputMode = 'decimal'; mgkgInput.placeholder = '0.00';
    mgkgInput.setAttribute('aria-label', 'Dose mg per kg');
    mgkgInput.value = rowObj.mgkg ?? '';
    mgkgWrap.appendChild(mgkgInput); mgkgWrap.appendChild(mgkgLabel);

    const mgmlWrap = document.createElement('div');
    mgmlWrap.className = 'field';
    const mgmlLabel = document.createElement('label'); mgmlLabel.textContent = 'mg/mL';
    const mgmlInput = document.createElement('input');
    mgmlInput.type = 'number'; mgmlInput.step = '0.01'; mgmlInput.min = '0';
    mgmlInput.inputMode = 'decimal'; mgmlInput.placeholder = '0.00';
    mgmlInput.setAttribute('aria-label', 'Concentration mg per mL');
    mgmlInput.value = rowObj.mgml ?? '';
    mgmlWrap.appendChild(mgmlInput); mgmlWrap.appendChild(mgmlLabel);

    // Rounding dropdown
    const roundWrap = document.createElement('div');
    roundWrap.className = 'field';
    const roundLabel = document.createElement('label'); roundLabel.textContent = 'Rounding';
    const roundSelect = document.createElement('select');
    roundSelect.setAttribute('aria-label', 'Rounding mode');
    [
      {v:'down', t:'Round down'},
      {v:'round', t:'Round'},
      {v:'up', t:'Round up'}
    ].forEach(opt=>{
      const o = document.createElement('option');
      o.value = opt.v;
      o.textContent = opt.t;
      roundSelect.appendChild(o);
    });
    roundSelect.value = (rowObj.roundMode === 'down' || rowObj.roundMode === 'up' || rowObj.roundMode === 'round') ? rowObj.roundMode : 'round';
    roundWrap.appendChild(roundSelect); roundWrap.appendChild(roundLabel);

    const delBtn = document.createElement('button');
    delBtn.className = 'custom-del'; delBtn.type = 'button';
    delBtn.title = 'Delete row'; delBtn.setAttribute('aria-label','Delete custom row');
    delBtn.textContent = '×';
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this custom row?')){
        tr.remove();
        customRows = customRows.filter(r => r.id !== rowObj.id);
        if(customRows.length === 0){
          const newRow = { id: genId(), name: '', mgkg: '', mgml: '', roundMode: 'round' };
          customRows.push(newRow);
          addCustomRow(tbody, newRow);
        }
        saveCustomRows(customRows);
        updateDoseTables();
        if(!isApplyingRemote) scheduleCloudPush();
      }
    });

    editor.appendChild(nameInput);
    editor.appendChild(mgkgWrap);
    editor.appendChild(mgmlWrap);
    editor.appendChild(roundWrap);

    tdName.appendChild(editor);
    tdName.appendChild(delBtn);
    tr.appendChild(tdName);

    const tdDose = document.createElement('td');
    tdDose.className = 'dose-cell';
    tdDose.textContent = '--';
    tr.appendChild(tdDose);

    function renderRow(){
      tr.dataset.amt = mgkgInput.value || '';
      tr.dataset.conc = mgmlInput.value || '';
      tr.dataset.round = roundSelect.value || 'round';

      const idx = customRows.findIndex(r => r.id === rowObj.id);
      if(idx !== -1){
        customRows[idx] = {
          id: rowObj.id,
          name: nameInput.value || '',
          mgkg: tr.dataset.amt,
          mgml: tr.dataset.conc,
          roundMode: tr.dataset.round
        };
        saveCustomRows(customRows);
      }
      updateDoseTables();
      if(!isApplyingRemote) scheduleCloudPush();
    }

    nameInput.addEventListener('input', renderRow);
    mgkgInput.addEventListener('input', renderRow);
    mgmlInput.addEventListener('input', renderRow);
    roundSelect.addEventListener('change', renderRow);

    tbody.appendChild(tr);
    renderRow();
  }

  function rebuildCustomTableFromModel(){
    const table = document.getElementById('tbl-custom');
    const tbody = table.tBodies[0];
    tbody.innerHTML = '';
    customRows.forEach(r => addCustomRow(tbody, r));
    updateDoseTables();
  }

  /******************** Notes (persistent) ********************/
  const NOTES_KEY = 'ratNotesRowsV1';
  function loadNotes(){
    try{
      const raw = storage.get(NOTES_KEY);
      const rows = raw ? JSON.parse(raw) : [];
      return Array.isArray(rows) ? rows : [];
    }catch(e){
      return [];
    }
  }
  function saveNotes(rows){ storage.set(NOTES_KEY, JSON.stringify(rows)); }

  function buildNotesTable(){
    const details = document.createElement('details');
    details.id = 'p13-notes';
    details.open = (storage.get('open:'+details.id) ?? '1') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>Notes</span><span class="meta"></span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div'); wrap.className = 'table-wrap';

    const table = document.createElement('table'); table.className = 'sop'; table.id = 'tbl-notes';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    thead.appendChild(trh); table.appendChild(thead);

    const tbody = document.createElement('tbody'); table.appendChild(tbody);

    wrap.appendChild(table);

    const foot = document.createElement('div'); foot.className = 'note';
    const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add note';
    addBtn.addEventListener('click', ()=>{
      const row = { id: genId(), text: '' };
      notesRows.push(row);
      saveNotes(notesRows);
      addNoteRow(tbody, row);
      if(!isApplyingRemote) scheduleCloudPush();
    });
    foot.appendChild(addBtn);

    const hint = document.createElement('div'); hint.className='note';
    hint.textContent = 'Notes are saved locally and included in cloud sync.';
    wrap.appendChild(foot);
    wrap.appendChild(hint);

    details.appendChild(wrap);
    app.appendChild(details);

    const stored = loadNotes();
    if(stored.length === 0){
      notesRows = [{ id: genId(), text: '' }];
      saveNotes(notesRows);
    }else{
      notesRows = stored.map(n => ({ id: n.id || genId(), text: n.text || '' }));
      saveNotes(notesRows);
    }
    notesRows.forEach(n => addNoteRow(tbody, n));
    return table;
  }

  function addNoteRow(tbody, row){
    const tr = document.createElement('tr'); tr.className='note-row'; tr.dataset.id = row.id;
    const td = document.createElement('td'); td.style.textAlign='left';

    const ta = document.createElement('textarea'); ta.className='notes-text';
    ta.placeholder = 'Type a note…';
    ta.value = row.text || '';
    ta.addEventListener('input', ()=>{
      const idx = notesRows.findIndex(n => n.id === row.id);
      if(idx !== -1){
        notesRows[idx] = { id: row.id, text: ta.value };
        saveNotes(notesRows);
      }
      if(!isApplyingRemote) scheduleCloudPush();
    });

    const del = document.createElement('button'); del.className='note-del'; del.textContent='×'; del.title='Delete note';
    del.addEventListener('click', ()=>{
      if(confirm('Delete this note?')){
        tr.remove();
        notesRows = notesRows.filter(n => n.id !== row.id);
        if(notesRows.length === 0){
          const r = { id: genId(), text: '' };
          notesRows.push(r);
          addNoteRow(tbody, r);
        }
        saveNotes(notesRows);
        if(!isApplyingRemote) scheduleCloudPush();
      }
    });

    td.appendChild(ta);
    td.appendChild(del);
    tr.appendChild(td);
    tbody.appendChild(tr);
  }

  function rebuildNotesFromModel(){
    const table = document.getElementById('tbl-notes');
    const tbody = table.tBodies[0];
    tbody.innerHTML = '';
    (notesRows.length ? notesRows : [{ id: genId(), text: '' }]).forEach(n => addNoteRow(tbody, n));
  }

  /******************** Cloud Sync / Backup (Firebase RTDB; auto, no password) ********************/
  const SYNC_ID_KEY = 'syncIdV1';
  const SYNC_LAST_KEY = 'syncLastAtV1';
  const CLIENT_ID = 'c-' + Math.random().toString(36).slice(2) + Date.now().toString(36);

  function saveSyncId(id){ storage.set(SYNC_ID_KEY, id||''); }
  function loadSyncId(){ return storage.get(SYNC_ID_KEY) || ''; }
  function saveLastSync(){ storage.set(SYNC_LAST_KEY, new Date().toISOString()); }
  function loadLastSync(){ return storage.get(SYNC_LAST_KEY) || ''; }

  function sanitizeId(id){
    // Firebase path cannot include . # $ [ ]
    return String(id||'').trim().replace(/[.#$\[\]]/g,'-');
  }

  function modelForSync(){
    return {
      version: 2,
      updatedAt: new Date().toISOString(),
      clientId: CLIENT_ID,
      data: {
        customRows: customRows,
        notesRows: notesRows,
      }
    };
  }

  function applyModelFromCloud(model){
    if(!model || !model.data) throw new Error('Invalid cloud payload');
    customRows = Array.isArray(model.data.customRows) ? model.data.customRows.map(r => ({
      id: r.id || genId(),
      name: r.name ?? '',
      mgkg: r.mgkg ?? '',
      mgml: r.mgml ?? '',
      roundMode: (r.roundMode === 'down' || r.roundMode === 'up' || r.roundMode === 'round') ? r.roundMode : 'round'
    })) : [];
    notesRows  = Array.isArray(model.data.notesRows)  ? model.data.notesRows.map(n => ({ id: n.id || genId(), text: n.text || '' })) : [];
    saveCustomRows(customRows);
    saveNotes(notesRows);
    rebuildCustomTableFromModel();
    rebuildNotesFromModel();
  }

  // Sync state shared with UI + change hooks
  let activeId = loadSyncId();
  let currentRef = null;
  let currentCallback = null;
  let isApplyingRemote = false;
  let isPushing = false;
  let readyToSync = false;
  let lastRemoteAt = 0;
  let lastPushedAt = 0;
  let pushTimer = null;

  // Will be replaced after sync table builds; used by Custom/Notes to queue pushes
  let scheduleCloudPush = ()=>{};

  function buildSyncTable(){
    const details = document.createElement('details');
    details.id = 'p14-sync';
    details.open = (storage.get('open:'+details.id) ?? '1') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>Cloud Sync</span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div'); wrap.className='table-wrap';

    const table = document.createElement('table'); table.className='sop'; table.id='tbl-sync';

    // No thead — by request
    const tbody = document.createElement('tbody');

    // Row: Sync ID (editable) + Generate + conditional Set ID
    const rId = document.createElement('tr');
    const cIdL = document.createElement('td'); cIdL.textContent='Sync ID'; rId.appendChild(cIdL);
    const cIdV = document.createElement('td'); cIdV.className='sync-field';

    const idField = document.createElement('input');
    idField.type='text';
    idField.placeholder='e.g. my-shared-id-123';
    idField.value = activeId;

    const btnGen = document.createElement('button'); btnGen.className='btn'; btnGen.textContent='Generate ID';
    btnGen.title='Generate a random ID (will take effect after Set ID)';
    const btnSet = document.createElement('button'); btnSet.className='btn good'; btnSet.textContent='Set ID';
    btnSet.style.display = 'none'; // appears only when changed

    cIdV.appendChild(idField); cIdV.appendChild(btnGen); cIdV.appendChild(btnSet);
    rId.appendChild(cIdV); tbody.appendChild(rId);

    // Row: Status
    const rSt = document.createElement('tr');
    const cStL = document.createElement('td'); cStL.textContent='Status'; rSt.appendChild(cStL);
    const cStV = document.createElement('td');
    const statusEl = document.createElement('div'); statusEl.className='status';
    const last = loadLastSync(); if(last){ statusEl.textContent = `Last push: ${new Date(last).toLocaleString()}`; }
    cStV.appendChild(statusEl); rSt.appendChild(cStV); tbody.appendChild(rSt);

    // Row: Info
    const rInfo = document.createElement('tr');
    const cInfoL = document.createElement('td'); cInfoL.textContent='Info'; rInfo.appendChild(cInfoL);
    const cInfoV = document.createElement('td');
    cInfoV.innerHTML = `
      <div class="note">Sync is automatic. Anyone with the Sync ID can read and write data; create a new Sync ID for sharing. Do not store sensitive information.</div>`;
    rInfo.appendChild(cInfoV); tbody.appendChild(rInfo);

    table.appendChild(tbody);
    wrap.appendChild(table);
    details.appendChild(wrap);
    app.appendChild(details);

    function setStatus(msg, kind){
      statusEl.textContent = msg;
      statusEl.classList.remove('ok','warn','err');
      if(kind) statusEl.classList.add(kind);
    }

    function showSetButtonIfChanged(){
      const v = sanitizeId(idField.value);
      btnSet.style.display = (v && v !== activeId) ? '' : 'none';
    }

    idField.addEventListener('input', showSetButtonIfChanged);

    btnGen.addEventListener('click', ()=>{
      const rid = 'id-' + Math.random().toString(36).slice(2,10) + '-' + Math.random().toString(36).slice(2,8);
      idField.value = rid;
      showSetButtonIfChanged();
      setStatus('Generated ID. Click “Set ID” to start syncing with it.', 'ok');
    });

    btnSet.addEventListener('click', async ()=>{
      const newId = sanitizeId(idField.value);
      if(!newId){ setStatus('Please enter a valid ID.', 'warn'); return; }
      await startSyncWithId(newId, {seedFromRemote:true});
      btnSet.style.display='none';
      setStatus(`Switched to ID: ${newId} (live)`, 'ok');
    });

    // Provide debounced push function for other tables
    scheduleCloudPush = function schedulePush(){
      if(!readyToSync || !activeId || !currentRef) return;
      if(isApplyingRemote) return; // don't echo remote data back
      if(pushTimer) clearTimeout(pushTimer);
      pushTimer = setTimeout(async ()=>{
        try{
          isPushing = true;
          const payload = modelForSync();
          await set(currentRef, payload);
          lastPushedAt = Date.now();
          saveLastSync();
          setStatus(`Pushed at ${new Date(lastPushedAt).toLocaleTimeString()}`, 'ok');
        }catch(err){
          setStatus('Push error: ' + err.message, 'err');
        }finally{
          isPushing = false;
        }
      }, 500); // debounce
    };

    // Start initial sync if we already have an ID
    if(activeId){
      startSyncWithId(activeId, {seedFromRemote:true}).then(()=>{
        setStatus(`Listening to ID: ${activeId}`, 'ok');
      }).catch(err=> setStatus('Sync error: ' + err.message, 'err'));
    }else{
      setStatus('Not syncing (no ID). Enter an ID or Generate one.', 'warn');
    }

    return table;

    /******** attach/detach + initial reconcile ********/
    async function startSyncWithId(newId, opts={seedFromRemote:true}){
      // Detach old listener
      if(currentRef && currentCallback){ off(currentRef, 'value', currentCallback); }
      activeId = newId;
      saveSyncId(activeId);

      currentRef = ref(db, pathForId(activeId));
      // First reconcile: if remote exists, load it; else push local model
      const snap = await get(currentRef);
      if(snap.exists()){
        const remote = snap.val();
        isApplyingRemote = true;
        try{
          applyModelFromCloud(remote);
          lastRemoteAt = Date.parse(remote.updatedAt || Date.now());
        }finally{
          isApplyingRemote = false;
        }
      }else{
        // Seed remote with our current local state
        const payload = modelForSync();
        await set(currentRef, payload);
        lastPushedAt = Date.now();
        saveLastSync();
      }

      // Attach live listener
      currentCallback = (snap)=>{
        const v = snap.val();
        if(!v) return;
        // Ignore echoes of our own write
        if(v.clientId === CLIENT_ID) return;
        // Apply newer remote
        const rAt = Date.parse(v.updatedAt || 0);
        if(!isFinite(rAt) || rAt <= lastRemoteAt) return;
        lastRemoteAt = rAt;
        isApplyingRemote = true;
        try{
          applyModelFromCloud(v);
        }catch(e){
          console.error(e);
        }finally{
          isApplyingRemote = false;
        }
      };
      onValue(currentRef, currentCallback);

      readyToSync = true;
    }
  }

  /******************** About table (single non-bold header; collapsed by default) ********************/
  function buildAboutTable(){
    const details = document.createElement('details');
    details.id = 'p15-about';
    // default CLOSED unless previously opened
    details.open = (storage.get('open:'+details.id) ?? '0') === '1';
    details.addEventListener('toggle', ()=> storage.set('open:'+details.id, details.open ? '1' : '0'));

    const summary = document.createElement('summary');
    summary.innerHTML = `<span>About</span><span class="meta"></span>`;
    details.appendChild(summary);

    const wrap = document.createElement('div'); wrap.className='table-wrap';
    const table = document.createElement('table'); table.className='sop'; table.id='tbl-about';

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    const th = document.createElement('th');
    th.textContent = 'Created by Alan Marcus - Version 20260213_1509';
    th.style.fontWeight = 'normal'; // not bold
    trh.appendChild(th); thead.appendChild(trh); table.appendChild(thead);

    const tbody = document.createElement('tbody'); table.appendChild(tbody);

    wrap.appendChild(table);
    details.appendChild(wrap);
    app.appendChild(details);
    return table;
  }

  /******************** Weight control ********************/
  const WEIGHT_KEY = 'ratWeightG';
  const actInput = document.getElementById('actWeight');
  const applyBtn = document.getElementById('applyActual');

  function currentWeightG(){
    return parseWeightG(actInput.value);
  }

  function setWeightFromInput(){
    const w = currentWeightG();
    if(w === null){
      storage.remove(WEIGHT_KEY);
    }else{
      storage.set(WEIGHT_KEY, String(w));
    }
    updateDoseTables();
  }

  applyBtn.addEventListener('click', setWeightFromInput);
  actInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); setWeightFromInput(); }});
  actInput.addEventListener('focus', () => {requestAnimationFrame(() => actInput.select());});
  ['mouseup','pointerup'].forEach(ev => actInput.addEventListener(ev, (e)=> e.preventDefault()));

  /******************** Dose updates ********************/
  function updateDoseTables(){
    const weightG = currentWeightG();

    // Update Drugs section title
    const drugsDetails = document.getElementById('p5-drugs');
    if(drugsDetails){
      const titleEl = drugsDetails.querySelector('summary .section-title');
      if(titleEl){
        const wtxt = (weightG === null) ? 'xxx.x' : Number(weightG).toFixed(1);
        titleEl.textContent = `Doses for ${wtxt} g rat`;
      }
    }

    // Drugs table rows
    const drugsTbl = document.getElementById('tbl-p5-drugs');
    if(drugsTbl){
      Array.from(drugsTbl.tBodies[0].rows).forEach(tr=>{
        const cell = tr.querySelector('td.dose-cell');
        const rule = ruleFromRow(tr);
        if(!cell || !rule){ cell.textContent = '--'; return; }
        const v = volFor(weightG, rule);
        const rounded = (weightG === null) ? null : roundTo2(v, tr.dataset.round || 'round');
        cell.textContent = fmt2(rounded);
      });
    }

    // Custom table rows
    const customTbl = document.getElementById('tbl-custom');
    if(customTbl){
      Array.from(customTbl.tBodies[0].rows).forEach(tr=>{
        const cell = tr.querySelector('td.dose-cell');
        const rule = ruleFromRow(tr);
        if(!cell || !rule){ cell.textContent = '--'; return; }
        const v = volFor(weightG, rule);
        const rounded = (weightG === null) ? null : roundTo2(v, tr.dataset.round || 'round');
        cell.textContent = fmt2(rounded);
      });
    }
  }

  /******************** Build sections ********************/
  const tblDrugs = buildDoseTable(
    'p5-drugs',
    'Drugs',
    'Prepare appropriate volumes of 1:10 dilutions, e.g. 1 ml buprenorphine + 9 ml sterile saline/water',
    drugs
  );
  const tblCustom = buildCustomTable();
  const tblNotes  = buildNotesTable();
  const tblSync   = buildSyncTable();
  const tblAbout  = buildAboutTable();

  /******************** Initial render ********************/
  tablesReady = true;
  const savedW = storage.get(WEIGHT_KEY);
  if(savedW){
    actInput.value = String(savedW);
  }else{
    actInput.value = '';
  }
  updateDoseTables();
</script>
</body>
</html>
