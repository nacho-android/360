<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Leaderboard – Pig Heart Injection</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a36; --text:#e5e7eb; --muted:#9ca3af; --accent:#7dd3fc; --gold:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:14px;background:linear-gradient(180deg,rgba(18,26,54,0.94),rgba(18,26,54,0.88));border-bottom:1px solid rgba(255,255,255,0.06)}
    main{padding:14px;max-width:1100px;margin:0 auto}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:12px}
    h1{margin:0 0 10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;font-size:14px}
    th{color:#cbd5e1}
    tr:hover{background:rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input[type=text]{background:#0b122a;color:#e5e7eb;border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:8px 10px}
    select{background:#0b122a;color:#e5e7eb;border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:8px 10px}
    a.btn,button{background:#1b2450;color:#fff;border:1px solid rgba(255,255,255,0.18);padding:8px 12px;border-radius:10px;text-decoration:none;cursor:pointer}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto">
      <div style="display:flex;align-items:center;gap:10px">
        <svg width="22" height="22" viewBox="0 0 64 64" aria-hidden="true"><path fill="#f87171" d="M47.5,6C41.2,6,36,10.3,32,16C28,10.3,22.8,6,16.5,6C7.9,6,1,13.4,1,22.7C1,41.1,32,58,32,58s31-16.9,31-35.3C63,13.4,56.1,6,47.5,6z"/></svg>
        <strong>Leaderboard</strong>
      </div>
      <div class="muted">Auto-updating from Firebase Realtime Database</div>
    </div>
  </header>
  <main>
    <div class="card">
      <div class="controls">
        <a class="btn" href="index.html">← Back to Game</a>
        <label class="small">Filter by name: <input id="filterName" type="text" placeholder="e.g., Dr Smith"></label>
        <label class="small">Max rows: 
          <select id="maxRows">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>250</option>
          </select>
        </label>
      </div>
      <table id="board">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Successful injections</th>
            <th>Bandages used</th>
            <th>Wands used</th>
            <th>Total time</th>
            <th>Attempt</th>
            <th class="muted">When</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const rowsEl = document.getElementById('rows');
    const filterName = document.getElementById('filterName');
    const maxRowsSel = document.getElementById('maxRows');

    const fmtTime = (ms)=>{
      const t = Math.max(0, ms|0);
      const m = Math.floor(t/60000);
      const s = Math.floor((t%60000)/1000);
      const ds = Math.floor((t%1000)/100);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ds}`;
    };
    const fmtWhen = (ts)=>{
      try{
        const d = new Date(ts);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleString();
      }catch{ return '-'; }
    };

    const computeRanked = (rawObj)=>{
      const arr = [];
      for(const [id, row] of Object.entries(rawObj || {})){
        arr.push({ id, ...row });
      }
      arr.sort((a,b)=>{
        // More successful is better
        if ((b.successfulInjections|0)!==(a.successfulInjections|0)) return (b.successfulInjections|0)-(a.successfulInjections|0);
        // Fewer bandages is better
        if ((a.bandagesUsed|0)!==(b.bandagesUsed|0)) return (a.bandagesUsed|0)-(b.bandagesUsed|0);
        // Fewer wands is better
        if ((a.wandsUsed|0)!==(b.wandsUsed|0)) return (a.wandsUsed|0)-(b.wandsUsed|0);
        // Lower total time is better
        if ((a.totalTimeMs|0)!==(b.totalTimeMs|0)) return (a.totalTimeMs|0)-(b.totalTimeMs|0);
        // Earlier entry wins tie
        return (a.createdAt?.seconds || a.createdAt || 0) - (b.createdAt?.seconds || b.createdAt || 0);
      });
      return arr;
    };

    const render = (list)=>{
      const nameFilter = (filterName.value || '').toLowerCase();
      const maxRows = parseInt(maxRowsSel.value, 10) || 50;
      rowsEl.innerHTML = '';
      let rank = 0;
      for(const row of list){
        if (nameFilter && !(row.name||'').toLowerCase().includes(nameFilter)) continue;
        rank += 1;
        if (rank > maxRows) break;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${escapeHtml(row.name || '—')}</td>
          <td>${row.successfulInjections|0}</td>
          <td>${row.bandagesUsed|0}</td>
          <td>${row.wandsUsed|0}</td>
          <td>${fmtTime(row.totalTimeMs|0)}</td>
          <td>${row.attempt|0}</td>
          <td class="muted">${fmtWhen(row.createdAt?.seconds ? row.createdAt.seconds*1000 : (row.createdAt||0))}</td>
        `;
        rowsEl.appendChild(tr);
      }
    };

    const escapeHtml = (str)=> String(str).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&#92;","'":"&#39;"}[m] || m));

    // Live subscribe
    onValue(ref(db, 'results'), (snap)=>{
      const ranked = computeRanked(snap.val());
      render(ranked);
    });

    filterName.addEventListener('input', ()=>{
      // re-render using cached last snapshot by reading from table? Simpler: re-fetch from cache by onValue above increments; so here we do nothing;
      // For immediate response, keep last list in window state:
    });
    maxRowsSel.addEventListener('change', ()=>{
      // No-op; on next onValue render will use new max. For immediate, could re-render with cached list.
    });
  </script>
</body>
</html>
